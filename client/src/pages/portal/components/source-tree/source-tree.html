<div *ngIf="tree">
  <ng-container *ngTemplateOutlet="importGroup; context: { enabled: true, type: 'component' }"></ng-container>
  <ng-container *ngTemplateOutlet="importGroup; context: { enabled: true, type: 'directive' }"></ng-container>
  <ng-container *ngTemplateOutlet="entityDecla; context: { model: tree.page, paths: undefined }"></ng-container>
</div>

<ng-template #importGroup let-enabled="enabled" let-type="type">
  <div class="section">
    <div class="common-decla">
      <div class="common-title">
        <div>
          <ng-container
            *ngTemplateOutlet="expandButton; context: {
              model: model,
              enabled: enabled,
              type: type,
              expanded: type === 'component'? tree.compExpanded: tree.direExpanded
            }"
          ></ng-container>
          <i nz-icon [nzType]=" type === 'component' ? 'appstore': 'api' " nzTheme="outline"></i>
          <span>{{ type === 'component'? '组件': '指令' }}</span>
        </div>
      </div>
      <ng-container *ngIf="type === 'component'? tree.compExpanded: tree.direExpanded">
        <div class="section" *ngFor="let comp of tree[type + 's']">
          <ng-container *ngTemplateOutlet="importDecla; context: { model: comp, type: type }"></ng-container>
        </div>
      </ng-container>
    </div>
  </div>
</ng-template>

<ng-template #importDecla let-model="model" let-type="type">
  <div class="import-decla">
    <i nz-icon [nzType]=" type === 'component' ? 'appstore': 'api' " nzTheme="outline"></i>
    <span [title]="model.id">{{ model.displayInfo.displayName }}</span>
  </div>
</ng-template>

<ng-template #entityDecla let-model="model" let-paths="paths">
  <div *ngIf="model" class="section" [class.not-root]="!!paths">
    <div class="common-decla">
      <div class="common-title">
        <ng-container *ngTemplateOutlet="entityTitleContent; context: { model: model }"></ng-container>
        <ng-container *ngTemplateOutlet="entityActions; context: { model: model, paths: paths }"></ng-container>
      </div>
      <div class="entity-children" *ngIf="checkIfShowChildren(model)">
        <ng-container *ngFor="let childNode of model.children">
          <ng-container
            *ngTemplateOutlet="entityDecla; context: {
              model: childNode,
              paths: !paths? model.id: (paths + '#' + model.id)
            }"
          ></ng-container>
        </ng-container>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #entityTitleContent let-model="model">
  <div>
    <ng-container
      *ngTemplateOutlet="expandButton; context: {
        model: model,
        enabled: model.children && model.children.length > 0,
        expanded: !!model.displayInfo.expanded,
        type: 'entity'
      }"
    ></ng-container>
    <i nz-icon nzType="layout" nzTheme="outline"></i>
    <span [title]="model.id">{{ model.displayInfo.displayName }}</span>
  </div>
</ng-template>

<ng-template #entityActions let-model="model" let-paths="paths">
  <div class="entity-actions">
    <i nz-icon nzType="plus-square" nzTheme="outline" (click)="onEntityCreateClick(model, paths)"></i>
    <i nz-icon nzType="form" nzTheme="outline" (click)="onEntityEditClick(model, paths)"></i>
    <i nz-icon nzType="delete" nzTheme="outline" (click)="onEntityDeleteClick(model, paths)" class="delete-btn"></i>
  </div>
</ng-template>

<ng-template #expandButton let-model="model" let-type="type" let-enabled="enabled" let-expanded="expanded">
  <i
    *ngIf="enabled"
    nz-icon
    [nzType]="!expanded? 'plus-circle': 'minus-circle'"
    nzTheme="outline"
    (click)="type === 'entity'? onEntityExpand(model): onGroupExpand(type)"
  ></i>
  <i *ngIf="!enabled" style="color: #888888" nz-icon nzType="stop" nzTheme="outline"></i>
</ng-template>

<style>
  :host {
    display: block;
    border: 1px solid #ececec;
    background: #fafafa;
  }

  .section {
    margin: 8px;
  }

  .not-root {
    margin-right: -1px;
  }

  .import-decla {
    border: 1px solid #ececec;
    background: #fff;
    padding: 4px;
    cursor: pointer;
    transition: background 0.35s;
  }

  .import-decla:hover {
    background: #f6f6f6;
  }

  .common-decla {
    border: 1px solid #ececec;
    background: #fff;
    padding: 0;
    cursor: pointer;
  }

  .import-decla i {
    margin-right: 4px;
  }

  .common-title {
    display: flex;
    justify-content: space-between;
    padding: 4px;
    transition: background 0.35s;
  }

  .entity-actions {
    padding-right: 4px;
  }

  .common-title .entity-actions {
    visibility: hidden;
  }

  .common-title:hover {
    background: #f6f6f6;
  }

  .common-title:hover .entity-actions {
    visibility: visible;
  }

  .common-title i {
    margin-right: 4px;
  }

  .entity-children {
    margin-top: 4px;
  }

  .delete-btn {
    transform: color 0.35s;
  }

  .delete-btn:hover {
    color: #ff4d4f;
  }
</style>
